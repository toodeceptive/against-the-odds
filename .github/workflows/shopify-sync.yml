# Shopify Sync: products from data/products/ to store
# Runs on push to main (product/theme paths), schedule, or manual.
# Secrets: SHOPIFY_STORE_DOMAIN, SHOPIFY_ACCESS_TOKEN (Settings > Actions > Secrets).
# Note: IDE may show "Context access might be invalid" for these secret namesâ€”known false positive
# (GitHub Actions extension doesn't list custom repo secrets). Workflow runs correctly when secrets are set.

name: Shopify Sync

on:
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM
  workflow_dispatch:
    inputs:
      apply_changes:
        description: 'Set true to perform write sync to Shopify (explicit approval required)'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
    paths:
      - 'data/products/**'
      - 'scripts/shopify/sync-products.ps1'

permissions:
  contents: read

jobs:
  sync-products:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sync products to Shopify
        if: github.event_name == 'workflow_dispatch' && (inputs.apply_changes == true || github.event.inputs.apply_changes == 'true')
        env:
          SHOPIFY_STORE_DOMAIN: ${{ secrets.SHOPIFY_STORE_DOMAIN }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        shell: pwsh
        run: |
          ./scripts/shopify/sync-products.ps1

      - name: Preview-only dry run (non-manual apply paths)
        if: github.event_name != 'workflow_dispatch' || (inputs.apply_changes != true && github.event.inputs.apply_changes != 'true')
        env:
          SHOPIFY_STORE_DOMAIN: ${{ secrets.SHOPIFY_STORE_DOMAIN }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        shell: pwsh
        run: |
          ./scripts/shopify/sync-products.ps1 -DryRun

  backup-store:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Run backups only on non-push events and only when required secrets are set.
    if: github.event_name != 'push' && secrets.SHOPIFY_STORE_DOMAIN != '' && secrets.SHOPIFY_ACCESS_TOKEN != ''
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Backup live theme to branch (REST)
        env:
          SHOPIFY_STORE_DOMAIN: ${{ secrets.SHOPIFY_STORE_DOMAIN }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
          SHOPIFY_ADMIN_API_VERSION: 2026-01
        shell: pwsh
        run: |
          ./scripts/shopify/theme-pull-rest.ps1 -Store $env:SHOPIFY_STORE_DOMAIN -ThemePath "src/shopify/themes/aodrop-theme" -Theme "live"

          if (-not (Test-Path "src/shopify/themes/aodrop-theme")) {
            throw "Theme path missing after pull."
          }

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Publish the pulled theme snapshot to a dedicated branch (force-updated)
          git checkout -B shopify-theme-backup
          git add "src/shopify/themes/aodrop-theme"

          $status = git status --porcelain
          if ([string]::IsNullOrWhiteSpace($status)) {
            Write-Host "No changes to commit; backup branch unchanged."
            exit 0
          }

          $stamp = (Get-Date).ToString("yyyy-MM-dd")
          git commit -m "chore: backup Shopify theme ($stamp)"
          git push origin shopify-theme-backup --force
